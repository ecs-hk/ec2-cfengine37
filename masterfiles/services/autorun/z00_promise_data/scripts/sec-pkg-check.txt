#!/bin/bash

# Managed by CFEngine

# This cronjob checks for package security updates and logs a messages
# if they are available. It excludes kernel and firmware packages.

# ------------------------------------------------------------------------- #
#			VARIABLE DEFINITIONS
# ------------------------------------------------------------------------- #

PATH=/bin:/usr/bin

readonly _me="${0##*/}"
readonly _output="/tmp/${_me}.log"

readonly _kern_pkgs='kernel* *-kmdl-* kmod-* *firmware*'

# ------------------------------------------------------------------------- #
#			FUNCTIONS
# ------------------------------------------------------------------------- #

yum_check_for_security_updates() {
        # yum(8) is giving inconsistent results with check-update vs. update,
        # so instead of relying on its sometimes erroneous exit code, we
        # have to grep(1) output.
        yum                                                             \
        --security                                                      \
        --exclude="${_kern_pkgs}"                                       \
        check-update                                                    \
        >"${_output}" 2>&1

        if grep -Eq '^No packages.*for security' "${_output}" ; then
                return
        elif grep -Eq '[0-9]+ package.*for security' "${_output}" ; then
                logger							\
		-p alert						\
		"${_me}: yum(8) security updates available"
        else
                logger							\
		-p local3.err						\
		"${_me}: yum(8) check failed (see ${_output})"
        fi
}

# ------------------------------------------------------------------------- #
#			MAIN LOGIC
# ------------------------------------------------------------------------- #

yum_check_for_security_updates

exit 0
