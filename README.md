# CFEngine 3.7 promises for Amazon EC2

## Synopsis

Baseline promises for managing AWS EC2 instances. Performs sshd, ntpd, and rsyslog configuration, keeps important services running, watches filesystem space, and checks for package security updates.

(Also see "Optional features" section below.)

Supported OSes:
* Amazon Linux AMI release 2015.09
* RHEL 6
* RHEL 7

Tested with packages:
* `cfengine-community-3.7.1-1.x86_64.rpm`

Official CFEngine packages:
https://cfengine.com/product/community/

## Deploy to CFEngine hub

### One-time install and setup

On the hub system, install the CFEngine package and clone this git repository. Then:

```
# cp -r ./ec2-cfengine37/masterfiles/* /var/cfengine/masterfiles

# cp -r /var/cfengine/masterfiles/* /var/cfengine/inputs

# service cfengine3 restart
```

### Customize for your environment

Edit vars.acl in `/var/cfengine/masterfiles/def.json` to include subnets you wish to allow in.

Always, **always** validate your JSON after editing it, or else CFEngine will silently ignore it.

```
# python -m json.tool < def.json
```

You will also need to add a rule to your EC2 Security Group to allow in TCP 5308 from CFEngine agents to the CFEngine hub.

### Bootstrap to yourself

This bootstrapping step will put the hub under CFEngine management, just like all managed agents.

```
# cf-agent --bootstrap 172.31.21.122
```

Use the IP address of your CFEngine hub instead of the above.

## Deploy to CFEngine agent

### One-time install, then bootstrap to the hub

On each agent system, install the CFEngine package. Then:

```
# cf-agent --bootstrap 172.31.21.122
```

Use the IP address of your CFEngine hub instead of the above.

---

# Optional features

Optional features are _not_ enabled by default. Each requires one or more steps to activate.

## Automatic installation of package security updates

By default, this promise collection warns (via logging) when package security updates are available. To install the package security updates automatically, create or edit the file `/usr/local/etc/cfengine.json` on each CFEngine hub system where the auto-install is desired. Populate it with the following:

```
{
    "securityUpdates": "install"
}
```

## Enable sshd(8) password authentication

By default, this promise collection enables sshd(8) pubkey authentication and disables all other authentication forms. To also enable password authentication, create or edit the file `/usr/local/etc/cfengine.json` on each CFEngine hub system where it's desired. Populate it with the following:

```
{
    "sshdPasswordAuth": "enable"
}
```

## Push encrypted backups (tarballs) to AWS S3

Automatic (encrypted) backups can be activated by completing the following steps.

### One-time AWS setup

1. Using AWS S3, create a bucket for encrypted backups. Note that [S3 bucket names must be globally-unique](http://docs.aws.amazon.com/AmazonS3/latest/dev/BucketRestrictions.html) (across all customer accounts!), so utilize a consistent prefix or suffix to help ensure uniqueness, e.g. `s3://my.org.encbkups/`
2. Using AWS IAM, create an account via IAM with appropriate permissions to write to the S3 bucket.

### One-time CFEngine hub setup

1. Create the file `masterfiles/services/autorun/z01_secrets/bkup-to-s3.key.txt` - and put a **strong** file encryption key inside it. This key will be used to AES-encrypt (and decrypt, if/when needed) your backup tarballs.
2. Create the file `masterfiles/services/autorun/z01_secrets/bkup-to-s3-creds.json` using the new IAM credentials and the name of the bucket you created.

### Setup on each CFEngine agent

1. Determine which directories should be backed up.
2. Create the file `/usr/local/etc/bkup-to-s3.list` - with a list of those directories, a la:

```
/etc
/var/www
/var/lib/openldap
```

The directories you specify will be all rolled into a single tarball, AES-encrypted, and then pushed to your S3 bucket. The encrypted tarball will be named after the agent hostname.

## Promise logging to a MySQL DB (e.g. AWS RDS)

### CFEngine configuration

In order to send all logging generated by these promises (along with a few other important syslog messages) to a MySQL DB, create the file `masterfiles/services/autorun/z01_secrets/rsyslog-mysql-creds.json` on your CFEngine hub. Populate it with appropriate URI and credential contents that follow the format:

```
{
    "host": "syslogdb.xyzxyz.us-southwest-88.rds.amazonaws.com",
    "pw": "goodpassword",
    "user": "someguy"
}
```

### DB setup

This promise logging makes use of the rsyslog ommysql module, which is already installed by this promise ruleset. Suggested SQL for creating your MySQL or MariaDB tables (as provided by the rsyslog-mysql package):

```
CREATE DATABASE Syslog;
USE Syslog;
CREATE TABLE SystemEvents
(
        ID int unsigned not null auto_increment primary key,
        CustomerID bigint,
        ReceivedAt datetime NULL,
        DeviceReportedTime datetime NULL,
        Facility smallint NULL,
        Priority smallint NULL,
        FromHost varchar(60) NULL,
        Message text,
        NTSeverity int NULL,
        Importance int NULL,
        EventSource varchar(60),
        EventUser varchar(60) NULL,
        EventCategory int NULL,
        EventID int NULL,
        EventBinaryData text NULL,
        MaxAvailable int NULL,
        CurrUsage int NULL,
        MinUsage int NULL,
        MaxUsage int NULL,
        InfoUnitID int NULL ,
        SysLogTag varchar(60),
        EventLogType varchar(60),
        GenericFileName VarChar(60),
        SystemID int NULL
);

CREATE TABLE SystemEventsProperties
(
        ID int unsigned not null auto_increment primary key,
        SystemEventID int NULL ,
        ParamName varchar(255) NULL ,
        ParamValue text NULL
);
```

Suggested SQL for creating your MySQL or MariaDB service accounts:

```
CREATE USER 'writeraccount'@'%' IDENTIFIED BY 'somepassword';

GRANT SELECT, INSERT ON Syslog.SystemEvents TO 'writeraccount'@'%';
GRANT SELECT, INSERT ON Syslog.SystemEventsProperties TO 'writeraccount'@'%';

CREATE USER 'readeraccount'@'%' IDENTIFIED BY 'someotherpassword';

GRANT SELECT ON Syslog.SystemEvents TO 'readeraccount'@'%';
GRANT SELECT ON Syslog.SystemEventsProperties TO 'readeraccount'@'%';

FLUSH PRIVILEGES;
```

Configure `rsyslog-mysql-creds.json` using the account with INSERT privileges so that it can write log entries to the table.

### Simple DB log viewer

Optionally, you can use the [simple-ommysql-viewer](https://github.com/ecs-hk/simple-ommysql-viewer) app to view log entries.
