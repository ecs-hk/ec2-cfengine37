# CFEngine 3.7 promises for Amazon Linux

## Synopsis

Baseline promises for managing AWS EC2 instances. Performs sshd, ntpd, and rsyslog configuration, keeps important services running, watches filesystem space, and checks for package security updates.

Supported OSes:
* Amazon Linux AMI release 2015.09
* RHEL 6
* RHEL 7

Tested with packages:
* `cfengine-community-3.7.1-1.x86_64.rpm`

Official CFEngine packages:
https://cfengine.com/product/community/

## Deploy to CFEngine hub

### One-time install and setup

On the hub system, install the CFEngine package and clone this git repository. Then:

```
# cp -r ./ec2-cfengine37/masterfiles/* /var/cfengine/masterfiles

# cp -r /var/cfengine/masterfiles/* /var/cfengine/inputs

# service cfengine3 restart
```

### Customize for your environment

Edit vars.acl in `/var/cfengine/masterfiles/def.json` to include subnets you wish to allow in.

Always, **always** validate your JSON after editing it, or else CFEngine will silently ignore it.

```
# python -m json.tool < def.json
```

You will also need to add a rule to your EC2 Security Group to allow in TCP 5308 from CFEngine agents to the CFEngine hub.

### Bootstrap to yourself

This bootstrapping step will put the hub under CFEngine management, just like all managed agents.

```
# cf-agent --bootstrap 172.31.21.122
```

Use the IP address of your CFEngine hub instead of the above.

## Deploy to CFEngine agent

### One-time install, then bootstrap to the hub

On each agent system, install the CFEngine package. Then:

```
# cf-agent --bootstrap 172.31.21.122
```

Use the IP address of your CFEngine hub instead of the above.

## Optional features

Optional features are _not_ enabled by default. Instead, they become active after the appropriate JSON configuration file is in place.

### Automatic installation of package security updates

By default, this promise collection warns (via logging) when package security updates are available. To install the package security updates automatically, create the file `/usr/local/etc/cfengine.json` on each CFEngine hub system where the auto-install is desired. Populate it with the following:

```
{
    "securityUpdates": "install"
}
```

### Push encrypted backups (tarballs) to AWS S3

Automatic (encrypted) backups can be activated by completing the following:

1. Create an s3://encbkups/ bucket
2. Setup an account via IAM with appropriate permissions to write to the bucket
3. Create the file `/var/cfengine/masterfiles/services/autorun/z00_promise_data/text/bkup-to-s3-secretkey.txt` on your CFEngine hub, with a **strong** key inside it
4. Create the file `/root/bkup-to-s3.list` on each CFEngine agent system, with a list of directories to be backed up, a la:
5. Configure aws CLI (`aws configure`) using the new account (created via IAM)

```
/etc
/var/www
/my/important/data
```

### Promise logging to a MySQL DB (e.g. AWS RDS)

#### CFEngine configuration

In order to send all logging generated by these promises (along with a few other important syslog messages) to a MySQL DB, create the file `/var/cfengine/masterfiles/services/autorun/z00_promise_data/json/rsyslog-mysql-creds.json` on your CFEngine hub. Populate it with appropriate URI and credential contents that follow the format:

```
{
    "host": "syslogdb.xyzxyz.us-southwest-88.rds.amazonaws.com",
    "pw": "goodpassword",
    "user": "someguy"
}
```

#### DB setup

This promise logging makes use of the rsyslog ommysql module, which is already installed by this promise ruleset. Suggested SQL for creating your MySQL or MariaDB tables (as provided by the rsyslog-mysql package):

```
CREATE DATABASE Syslog;
USE Syslog;
CREATE TABLE SystemEvents
(
        ID int unsigned not null auto_increment primary key,
        CustomerID bigint,
        ReceivedAt datetime NULL,
        DeviceReportedTime datetime NULL,
        Facility smallint NULL,
        Priority smallint NULL,
        FromHost varchar(60) NULL,
        Message text,
        NTSeverity int NULL,
        Importance int NULL,
        EventSource varchar(60),
        EventUser varchar(60) NULL,
        EventCategory int NULL,
        EventID int NULL,
        EventBinaryData text NULL,
        MaxAvailable int NULL,
        CurrUsage int NULL,
        MinUsage int NULL,
        MaxUsage int NULL,
        InfoUnitID int NULL ,
        SysLogTag varchar(60),
        EventLogType varchar(60),
        GenericFileName VarChar(60),
        SystemID int NULL
);

CREATE TABLE SystemEventsProperties
(
        ID int unsigned not null auto_increment primary key,
        SystemEventID int NULL ,
        ParamName varchar(255) NULL ,
        ParamValue text NULL
);
```

Suggested SQL for creating your MySQL or MariaDB service accounts:

```
CREATE USER 'writeraccount'@'%' IDENTIFIED BY 'somepassword';

GRANT SELECT, INSERT ON Syslog.SystemEvents TO 'writeraccount'@'%';
GRANT SELECT, INSERT ON Syslog.SystemEventsProperties TO 'writeraccount'@'%';

CREATE USER 'readeraccount'@'%' IDENTIFIED BY 'someotherpassword';

GRANT SELECT ON Syslog.SystemEvents TO 'readeraccount'@'%';
GRANT SELECT ON Syslog.SystemEventsProperties TO 'readeraccount'@'%';

FLUSH PRIVILEGES;
```

Configure `rsyslog-mysql-creds.json` using the account with INSERT privileges so that it can write log entries to the table.

#### Simple DB log viewer

Optionally, you can use the [simple-ommysql-viewer](https://github.com/ecs-hk/simple-ommysql-viewer) app to view log entries.
